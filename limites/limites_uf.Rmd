---
title: "Limites"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: https://github.com/andreferraribr/lrf
    social: [ "twitter", "facebook", "menu" ]
runtime : shiny 
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
#library(httr)
library(tidyverse)
library(readxl)
library(DT)
library(plotly)
#library(leaflet)
#library(brazilmaps)
#library(shinyWidgets)
#library(shiny)
#library(sf)
library(vroom)
#library(spdplyr)
#library(htmltools)
```

```{r}
# importar df com os dados

df_limites<- read_csv("df_limites.csv")



```


Inputs {.sidebar}
-------------------------------------
```{r, input e reactive UF}
# atenção, variáveis terminam com "uf"
selectInput("uf", label = h3("escolha o Estado:"), 
    choices = unique(df_limites$uf), 
    selected = "SC")


limites_reactive <- reactive({ df_limites%>% filter (uf == input$uf)})


pessoal_df<-df_limites %>% filter(startsWith(conta, "DESPESA"))
dcl_df<-df_limites %>% filter(conta == "% da DCL sobre a RCL (III/RCL)")


rcl_df<-df_limites %>% filter(startsWith(conta, "RECEI")) %>% select(uf,exercicio, valor) %>% mutate (rcl = valor, uf_exercicio = paste0(uf,"-",exercicio))%>% select(uf_exercicio, rcl)
prev_df<-df_limites %>% filter (startsWith(conta, "Resultado")) %>% mutate (resultado = valor, uf_exercicio = paste0(uf,"-",exercicio))
prev_df<- left_join(prev_df, rcl_df) %>% mutate (valor = resultado / rcl *100)%>% mutate (cores = if_else(valor > 0, "superavitário","deficitário"))

#prev_df$cores <- factor(prev_df$cores, levels = c("superavitário","deficitário"))

invest_df<-df_limites %>% filter(startsWith(conta, "INVEST"))%>% mutate (investimento = valor, uf_exercicio = paste0(uf,"-",exercicio))


invest_df<- left_join(invest_df, rcl_df) %>% mutate (valor = investimento / rcl *100)%>% mutate (cores = if_else(valor > 5, "maior que 5% da RCL","menor ou igual a 5% da RCL"))

levels(invest_df$cores) <- c("menor ou igual a 5% da RCL","maior que 5% da RCL")



plot_df = function(df,corte){
  p <- ggplot(df, aes(x=exercicio, y=valor, color = cores)) +
  geom_jitter( data = df %>% filter (uf != input$uf), aes(text=paste("UF: ", uf)), width=0.25, alpha=0.5) +
 
  geom_point(data = df %>% filter (uf == input$uf ), aes(x=exercicio, y=valor,text=paste("UF: ", uf), size = 10))+
  # inherit.aes =FALSE para nao herdar aes do geoms anteriores
  geom_line(data = df %>% filter (uf == input$uf ),  inherit.aes =FALSE, aes(x=exercicio, y=valor,text=paste("UF: ", uf)), width=0.25, alpha=0.5)+
  geom_hline(yintercept=corte, colour = "red", width=0.1, linetype = "dashed") +
  #geom_hline(yintercept=44.5, colour = "orange", width=0.1) +
  geom_smooth( method = "auto", inherit.aes =FALSE,aes(x=exercicio, y=valor), color = "gray" )+
  theme(axis.text.x = element_text( hjust = 0.1)) +
  labs(x = "Ano",
       y = "%")+ theme_classic()+ 
  # alterar mutate cores para pessoal(descumprir limite legal, descumprir limite prudencial, cumprir limite), dcl (cumprir e descumprir), invest (acima de 10%, abaixo de 10%), prev (superavitario, deficitario)
  scale_color_manual(breaks = levels(df$cores),
                        values=c("red", "blue"))

(p <- ggplotly(p))%>% layout(showlegend = FALSE)
}

```


Row
-----------------------------------------------------------------------



### Despesa Pessoal

```{r}
renderPlotly(
  plot_df(pessoal_df, 49)
)
```



### DCL
```{r}

renderPlotly(
  plot_df(dcl_df, 200)
)
```




Row
-----------------------------------------------------------------------




### Previdencia


```{r}
renderPlotly(
  plot_df(prev_df, 0)
)
```



### Investimento

```{r}

renderPlotly(
  plot_df(invest_df, 5)
)
```

