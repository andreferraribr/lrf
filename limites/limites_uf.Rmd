---
title: "Limites"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: https://github.com/andreferraribr/lrf
    social: [ "twitter", "facebook", "menu" ]
runtime : shiny 
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
#library(httr)
library(tidyverse)
library(readxl)
library(DT)
library(plotly)
#library(leaflet)
#library(brazilmaps)
#library(shinyWidgets)
#library(shiny)
#library(sf)
library(vroom)
#library(spdplyr)
#library(htmltools)
```

```{r}
# importar df com os dados

df_limites<- read_csv("df_limites.csv")



```


Inputs {.sidebar}
-------------------------------------
```{r, input e reactive UF}
# atenção, variáveis terminam com "uf"
selectInput("uf", label = h3("escolha o Estado:"), 
    choices = unique(df_limites$uf), 
    selected = "SC")


limites_reactive <- reactive({ df_limites%>% filter (uf == input$uf)})


pessoal_df<-df_limites %>% filter(startsWith(conta, "DESPESA"))
dcl_df<-df_limites %>% filter(conta == "% da DCL sobre a RCL (III/RCL)")


rcl_df<-df_limites %>% filter(startsWith(conta, "RECEI")) %>% select(uf,exercicio, valor) %>% mutate (rcl = valor, uf_exercicio = paste0(uf,"-",exercicio))%>% select(uf_exercicio, rcl)
prev_df<-df_limites %>% filter (startsWith(conta, "Resultado")) %>% mutate (resultado = valor, uf_exercicio = paste0(uf,"-",exercicio))
prev_df<- left_join(prev_df, rcl_df) %>% mutate (valor = resultado / rcl *100)%>% mutate (cores = if_else(valor > 0, "superavitário","deficitário"))
levels(prev_df$cores) <- c("superavitário","deficitário")


invest_df<-df_limites %>% filter(startsWith(conta, "INVEST"))%>% mutate (investimento = valor, uf_exercicio = paste0(uf,"-",exercicio))


invest_df<- left_join(invest_df, rcl_df) %>% mutate (valor = investimento / rcl *100)%>% mutate (cores = if_else(valor > 5, "maior que 5% da RCL","menor ou igual a 5% da RCL"))

levels(invest_df$cores) <- c("menor ou igual a 5% da RCL","maior que 5% da RCL")

```


Row
-----------------------------------------------------------------------



### Despesa Pessoal

```{r, chart 1}

# selecionar UF para geom_line e geom_point
pessoal_uf_df<- pessoal_df %>% filter (uf == "RJ")
# df para plotar geom_line com UF selecionada
pessoal_uf_df_line<- pessoal_df %>% filter (uf == "RJ") 
# excluir UF da DF do geom_jitter 
pessoal_todos <-pessoal_df %>% filter (uf != "RJ")

desp_pessoal_plot <- ggplot(pessoal_todos, aes(x=exercicio, y=valor, color = cores)) +
  geom_jitter( aes(text=paste("UF: ", uf)), width=0.25, alpha=0.5) +
 
  geom_point(data = pessoal_uf_df, aes(x=exercicio, y=valor,text=paste("UF: ", uf)))+
  # inherit.aes =FALSE para nao herdar aes do geoms anteriores
  geom_line(data = pessoal_uf_df_line,  inherit.aes =FALSE, aes(x=exercicio, y=valor,text=paste("UF: ", uf)), width=0.25, alpha=0.5)+
  geom_hline(yintercept=49, colour = "red", width=0.1, linetype = "dashed") +
  #geom_hline(yintercept=44.5, colour = "orange", width=0.1) +
  geom_smooth( method = "auto", inherit.aes =FALSE,aes(x=exercicio, y=valor) )+
  theme(axis.text.x = element_text( hjust = 0.1)) +
  labs(title = "Despesa de Pessoal como % da RCL",
       x = "Ano",
       y = "%")+ theme_classic()+ 
  # alterar mutate cores para pessoal(descumprir limite legal, descumprir limite prudencial, cumprir limite), dcl (cumprir e descumprir), invest (acima de 10%, abaixo de 10%), prev (superavitario, deficitario)
  scale_color_manual(breaks = levels(pessoal_df$cores),
                        values=c("red", "blue"))

(desp_pessoal_plot <- ggplotly(desp_pessoal_plot))


```

### DCL
```{r}

dcl_uf_df<- dcl_df %>% filter (uf == "RJ")
dcl_uf_df_line<- dcl_df %>% filter (uf == "RJ") %>% select(-cores)
dcl_todos <-dcl_df %>% filter (uf != "RJ")

dcl_plot <- ggplot(dcl_df, aes(x=exercicio, y=valor, color = cores)) +
  geom_jitter( aes(text=paste("UF: ", uf)), width=0.25, alpha=0.5) +
 
  geom_point(data = dcl_uf_df, aes(x=exercicio, y=valor,text=paste("UF: ", uf), size = 10))+
  
  geom_line(data = dcl_uf_df_line,  inherit.aes =FALSE, aes(x=exercicio, y=valor,text=paste("UF: ", uf)), width=0.25, alpha=0.5)+
  geom_hline(yintercept=200, colour = "red", width=0.1, type = "dashed") +
  #geom_hline(yintercept=44.5, colour = "orange", width=0.1) +
  geom_smooth(method = "auto", inherit.aes =FALSE,aes(x=exercicio, y=valor) )+
  theme(axis.text.x = element_text( hjust = 0.1)) +
  labs(title = "Divida consolidada Liquida como % da RCL",
       x = "Ano",
       y = "%")+ theme_classic()+ 
  scale_color_manual(breaks = levels(dcl_df),
                        values=c("red", "blue"))

(dcl_plot <- ggplotly(dcl_plot))
```




Row
-----------------------------------------------------------------------




### Previdencia


```{r}
prev_uf_df<- prev_df %>% filter (uf == "ES")
prev_uf_df_line<- prev_df %>% filter (uf == "ES") %>% select(-cores)
prev_todos <-prev_df %>% filter (uf != "ES")

prev_plot <- ggplot(prev_todos, aes(x=exercicio, y=valor, color = cores)) +
  geom_jitter( aes(text=paste("UF: ", uf)), width=0.25, alpha=0.5) +
 
  geom_point(data = prev_uf_df, aes(x=exercicio, y=valor,text=paste("UF: ", uf), size = 10))+
  
  geom_line(data = prev_uf_df_line,  inherit.aes =FALSE, aes(x=exercicio, y=valor,text=paste("UF: ", uf)), width=0.25, alpha=0.5)+
  geom_hline(yintercept=0, colour = "red", width=0.1, linetype = "dashed") +
  #geom_hline(yintercept=44.5, colour = "orange", width=0.1) +
  geom_smooth(method = "auto", inherit.aes =FALSE,aes(x=exercicio, y=valor) )+
  theme(axis.text.x = element_text( hjust = 0.1)) +
  labs(title = "Resultado Previdenciario como % da RCL",
       x = "Ano",
       y = "%")+ theme_classic()+ 
  scale_color_manual(breaks = levels(prev_df$cores),
                        values=c("blue", "red"))

(prev_plot <- ggplotly(prev_plot))
```



### Investimento

```{r}


invest_uf_df<- invest_df %>% filter (uf == "RJ")
invest_uf_df_line<- invest_df %>% filter (uf == "RJ") %>% select(-cores)
invest_todos <-invest_df %>% filter (uf != "RJ")

invest_plot <- ggplot(invest_todos, aes(x=exercicio, y=valor, color = cores)) +
  geom_jitter( aes(text=paste("UF: ", uf)), width=0.25, alpha=0.5) +
 
  geom_point(data = invest_uf_df, aes(x=exercicio, y=valor,text=paste("UF: ", uf), size = 10))+
  
  geom_line(data = invest_uf_df_line,  inherit.aes =FALSE, aes(x=exercicio, y=valor,text=paste("UF: ", uf)), width=0.25, alpha=0.5)+
  geom_hline(yintercept=5, colour = "red", width=0.1, linetype = "dashed") +
  #geom_hline(yintercept=44.5, colour = "orange", width=0.1) +
  geom_smooth(method = "auto", inherit.aes =FALSE,aes(x=exercicio, y=valor) )+
  theme(axis.text.x = element_text( hjust = 0.1)) +
  labs(title = "Investimento como % da RCL",
       x = "Ano",
       y = "%")+ theme_classic()+ 
  scale_color_manual(breaks = levels(invest_df$cores),
                        values=c("red", "blue"))

(invest_plot <- ggplotly(invest_plot))

```

